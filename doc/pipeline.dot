strict digraph Pipeline {
subgraph Inputs {
node [shape=diamond, color=red, fontcolor=red]
"T1 image"
"MNI reference"
"MNI reference brain"
"Lobe map (reference space)"
"Brain mask (reference space)"
"DTI image"
"bvec"
"bval"
}
subgraph Outputs {
node[shape=rect, color=blue, fontcolor=blue];
"T1 brain image" 
"T1 cropped brain image" 
"T1 cropped image"
"T1 skull image"
"GM/WM maps"
"T1 bet-nonuniformity-corrected image"
"Crop parameters"
"T1 to Reference linear transformation"
"T1 to Reference non-linear transformation"
"Reference to T1 non-linear transformation"
"Lobe map (native space)"
"Brain mask (native space)"
"NU corrected T1"
"Eddy corrected image"
"DTI brain mask"
"FA image"
"MD image"
"FA image (T1 space)"
"MD image (T1 space)"
"DTI to T1 linear transformation"
"stats.txt"
"stats_simple.txt"
"Complex atlas"
"Simple atlas"
"Structural index"
"DTI brain image"
"DTI structural image"
}
subgraph clustermaps{
"T1 image" -> "Brain extraction (BET)" -> "T1 brain image"
"Brain extraction (BET)" -> "T1 skull image"
"T1 skull image" -> "Crop parameters"
"T1 image" -> "Crop parameters"
{"T1 image", "Crop parameters"} -> "T1 crop" -> "T1 cropped image"
{"T1 brain image", "Crop parameters"} -> "T1 crop brain" -> "T1 cropped brain image"
"T1 cropped brain image" -> "Tissue classification (FAST)"
"Tissue classification (FAST)" -> {"GM/WM maps", "T1 bet-nonuniformity-corrected image"}
{"T1 bet-nonuniformity-corrected image", "MNI reference brain"} -> "Linear registration (FLIRT)" -> "T1 to Reference linear transformation"
{"T1 to Reference linear transformation", "T1 cropped image", "MNI reference"} -> "T1 to Reference non-linear registration (FNIRT)" -> "T1 to Reference non-linear transformation"
{"T1 to Reference non-linear transformation" -> Invwarp -> "Reference to T1 non-linear transformation"}
{"Lobe map (reference space)", "Reference to T1 non-linear transformation"} -> "Transform lobe map (applywarp)" -> "Lobe map (native space)"
{"Brain mask (reference space)", "Reference to T1 non-linear transformation"} -> "Transform brain mask (applywarp)" -> "Brain mask (native space)"
{"Lobe map (native space)", "GM/WM maps"} -> "Complex atlas"
"Complex atlas" -> "Simple atlas"
}

subgraph "clusterT1 data" {
"T1 cropped image" -> "Non-uniformity correction (mri_nu_correct.mni)" -> "NU corrected T1"
}

subgraph "clusterDTI" {
bval -> "Structural index"
{"DTI image", "Structural index"} -> "Eddy correction (eddy_correct)" -> "Eddy corrected image"
"Eddy corrected image" -> "DTI brain extraction (BET)" -> {"DTI brain mask", "DTI brain image"}
{"Eddy corrected image", "bvec", "bval", "DTI brain mask"} -> dtifit -> {"FA image", "MD image"}
{"DTI brain image", "Structural index"} -> "Extract struct image (fslroi)" -> "DTI structural image"
{"DTI structural image", "T1 cropped brain image"} -> "DTI linear registration" -> "DTI to T1 linear transformation"
{"DTI to T1 linear transformation", "FA image"} -> "Transform FA (applywarp)" -> "FA image (T1 space)"
{"DTI to T1 linear transformation", "MD image"} -> "Transform MD (applywarp)" -> "MD image (T1 space)"
}

{"NU corrected T1", "Complex atlas", "Brain mask (native space)", "FA image (T1 space)", "MD image (T1 space)"} -> "Calc stats" -> "stats.txt"
{"NU corrected T1", "Simple atlas", "Brain mask (native space)", "FA image (T1 space)", "MD image (T1 space)"} -> "Calc stats" -> "stats_simple.txt"

}